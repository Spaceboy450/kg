<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>PDF –ø–æ —Ü–≤–µ—Ç—É</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body>
  <h1>üé® –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ —Ü–≤–µ—Ç—É</h1>

  <div class="panel">
    <form id="uploadForm">
      <label>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–∞–ø–∫–∞):
        <input type="file" name="images" id="images" webkitdirectory multiple required>
      </label><br><br>

      <label>–¶–µ–ª–µ–≤–æ–π —Ü–≤–µ—Ç: <input type="color" name="targetColor" value="#ff0000"></label><br>
      <label>–î–æ–ø—É—Å–∫ (¬∞): <input type="number" name="tolerance" value="10" min="1" max="180"></label><br>
      <label>–°—Ç—Ä–æ–∫–∏ (1‚Äì5): <input type="number" name="rows" value="5" min="1" max="5"></label><br>
      <label>–°—Ç–æ–ª–±—Ü—ã (1‚Äì5): <input type="number" name="cols" value="5" min="1" max="5"></label><br>
      <label>–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è:
        <select name="orientation">
          <option value="portrait">–ü–æ—Ä—Ç—Ä–µ—Ç</option>
          <option value="landscape">–ê–ª—å–±–æ–º</option>
        </select>
      </label><br><br>

      <button type="button" id="selectAndGenerateBtn">–û—Ç–æ–±—Ä–∞—Ç—å –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF</button>
    </form>

    <div id="errorBlock" class="errors"></div>
  </div>

  <div id="selectionResult" style="display:none;">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–±–æ—Ä–∞</h2>
    <div class="columns">
      <div class="col">
        <h3>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π</h3>
        <div id="leftColumn"></div>
      </div>
      <div class="col">
        <h3>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ —á–∞—Å–æ–≤–æ–π</h3>
        <div id="rightColumn"></div>
      </div>
    </div>
  </div>

  <div id="result"></div>

  <script>
    const form = document.getElementById("uploadForm");
    const errorBlock = document.getElementById("errorBlock");
    const resultDiv = document.getElementById("result");

    document.getElementById("selectAndGenerateBtn").addEventListener("click", async () => {
      const formData = new FormData(form);
      errorBlock.style.display = "none";
      document.getElementById("leftColumn").innerHTML = "";
      document.getElementById("rightColumn").innerHTML = "";
      resultDiv.innerHTML = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";

      try {
        // 1. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–±–æ—Ä
        const respSelect = await fetch("/select", { method: "POST", body: formData });
        const dataSelect = await respSelect.json();

        if (dataSelect.error) {
          errorBlock.style.display = "block";
          errorBlock.innerHTML = `<strong>${dataSelect.error}</strong>`;
          resultDiv.innerHTML = "";
          return;
        }

        if (dataSelect.errors && dataSelect.errors.length) {
          errorBlock.style.display = "block";
          errorBlock.innerHTML = "<strong>–û—à–∏–±–∫–∏:</strong><ul>" +
            dataSelect.errors.map(e => `<li>${e}</li>`).join("") + "</ul>";
        }

        const renderColumn = (containerId, items, emptyMessage) => {
          const container = document.getElementById(containerId);
          container.innerHTML = "";
          if (items.length === 0) {
            container.innerHTML = `<p><em>${emptyMessage}</em></p>`;
          } else {
            items.forEach(item => {
              const byteChars = atob(item.preview);
              const byteNumbers = new Array(byteChars.length);
              for (let i = 0; i < byteChars.length; i++) {
                byteNumbers[i] = byteChars.charCodeAt(i);
              }
              const byteArray = new Uint8Array(byteNumbers);
              const blob = new Blob([byteArray], { type: item.mime || "image/jpeg" });
              const url = URL.createObjectURL(blob);

              container.innerHTML += `
                <div>
                  <img src="${url}" alt="preview"><br>
                  ${item.caption}
                </div>
              `;
            });
          }
        };

        renderColumn("leftColumn", dataSelect.left, "‚ùå –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π");
        renderColumn("rightColumn", dataSelect.right, "‚ùå –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ —á–∞—Å–æ–≤–æ–π");

        document.getElementById("selectionResult").style.display = "block";

        // 2. –ó–∞—Ç–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF
        const respProcess = await fetch("/process", { method: "POST", body: formData });
        const dataProcess = await respProcess.json();

        if (dataProcess.error) {
          errorBlock.style.display = "block";
          errorBlock.innerHTML = `<strong>${dataProcess.error}</strong>`;
          resultDiv.innerHTML = "";
          return;
        }

        resultDiv.innerHTML = `
          <iframe src="${dataProcess.pdf_url}"></iframe>
          <p><a href="${dataProcess.pdf_url}" download="result.pdf">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å PDF</a></p>
        `;

      } catch (err) {
        errorBlock.style.display = "block";
        errorBlock.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${err}`;
        resultDiv.innerHTML = "";
      }
    });
  </script>
</body>
</html>