<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>PDF –ø–æ —Ü–≤–µ—Ç—É</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
  <style>
    .empty-msg {
      color: #666;
      font-style: italic;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h1>üé® –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ —Ü–≤–µ—Ç—É</h1>

  <div class="panel">
    <form id="uploadForm">
      <label>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–∞–ø–∫–∞):
        <input type="file" name="images" id="images" webkitdirectory multiple required>
      </label><br><br>

      <label>–¶–µ–ª–µ–≤–æ–π —Ü–≤–µ—Ç: <input type="color" name="targetColor" value="#ff0000"></label><br>
      <label>–î–æ–ø—É—Å–∫ (¬∞): <input type="number" name="tolerance" value="10" min="1" max="180"></label><br>
      <label>–°—Ç—Ä–æ–∫–∏ (1‚Äì5): <input type="number" name="rows" value="5" min="1" max="5"></label><br>
      <label>–°—Ç–æ–ª–±—Ü—ã (1‚Äì5): <input type="number" name="cols" value="5" min="1" max="5"></label><br>
      <label>–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è:
        <select name="orientation">
          <option value="portrait">–ü–æ—Ä—Ç—Ä–µ—Ç</option>
          <option value="landscape">–ê–ª—å–±–æ–º</option>
        </select>
      </label><br><br>

      <button type="button" id="selectAndGenerateBtn">–û—Ç–æ–±—Ä–∞—Ç—å –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF</button>
    </form>

    <div id="errorBlock" class="errors"></div>
  </div>

  <div id="selectionResult" style="display:none;">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–±–æ—Ä–∞</h2>
    <div class="columns">
      <div class="col">
        <h3>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π</h3>
        <div id="leftColumn"></div>
      </div>
      <div class="col">
        <h3>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ —á–∞—Å–æ–≤–æ–π</h3>
        <div id="rightColumn"></div>
      </div>
    </div>
  </div>

  <div id="result"></div>

  <script>
    const form = document.getElementById("uploadForm");
    const errorBlock = document.getElementById("errorBlock");
    const resultDiv = document.getElementById("result");
    const selectionResult = document.getElementById("selectionResult");

    let lastPdfUrl = null;
    let lastImageUrls = [];

    function clearObjectUrls() {
      if (lastPdfUrl) {
        URL.revokeObjectURL(lastPdfUrl);
        lastPdfUrl = null;
      }
      lastImageUrls.forEach(url => URL.revokeObjectURL(url));
      lastImageUrls = [];
    }

    function renderPreview(base64, caption, container) {
      const byteChars = atob(base64);
      const byteNumbers = new Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) {
        byteNumbers[i] = byteChars.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: "image/jpeg" });
      const url = URL.createObjectURL(blob);
      lastImageUrls.push(url);

      const wrapper = document.createElement("div");
      const img = document.createElement("img");
      img.src = url;
      img.style.maxWidth = "100px";
      const label = document.createElement("div");
      label.innerText = caption;

      wrapper.appendChild(img);
      wrapper.appendChild(label);
      container.appendChild(wrapper);
    }

    document.getElementById("selectAndGenerateBtn").addEventListener("click", async () => {
      const formData = new FormData(form);

      // üîπ –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
      errorBlock.style.display = "none";
      errorBlock.innerHTML = "";
      document.getElementById("leftColumn").innerHTML = "";
      document.getElementById("rightColumn").innerHTML = "";
      resultDiv.innerHTML = "";
      selectionResult.style.display = "none";

      clearObjectUrls();

      resultDiv.innerHTML = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";

      try {
        // 1. –û—Ç–±–æ—Ä
        const respSelect = await fetch("/select", { method: "POST", body: formData });
        const dataSelect = await respSelect.json();

        if (dataSelect.error) {
          errorBlock.style.display = "block";
          errorBlock.innerHTML = `<strong>${dataSelect.error}</strong>`;
          resultDiv.innerHTML = "";
          return;
        }

        if (dataSelect.errors && dataSelect.errors.length) {
          errorBlock.style.display = "block";
          errorBlock.innerHTML = "<strong>–û—à–∏–±–∫–∏:</strong><ul>" +
            dataSelect.errors.map(e => `<li>${e}</li>`).join("") + "</ul>";
        }

        const leftCol = document.getElementById("leftColumn");
        const rightCol = document.getElementById("rightColumn");

        if (dataSelect.left.length > 0) {
          dataSelect.left.forEach(item => renderPreview(item.preview, item.caption, leftCol));
        } else {
          leftCol.innerHTML = "<p class='empty-msg'>‚ùå –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>";
        }

        if (dataSelect.right.length > 0) {
          dataSelect.right.forEach(item => renderPreview(item.preview, item.caption, rightCol));
        } else {
          rightCol.innerHTML = "<p class='empty-msg'>‚ùå –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>";
        }

        selectionResult.style.display = "block";

        // 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF
        const respProcess = await fetch("/process", { method: "POST", body: formData });
        const dataProcess = await respProcess.json();

        if (dataProcess.error) {
          errorBlock.style.display = "block";
          errorBlock.innerHTML = `<strong>${dataProcess.error}</strong>`;
          resultDiv.innerHTML = "";
          return;
        }

        const pdfResp = await fetch(dataProcess.pdf_url);
        const pdfBuffer = await pdfResp.arrayBuffer();
        const pdfBlob = new Blob([pdfBuffer], { type: "application/pdf" });
        lastPdfUrl = URL.createObjectURL(pdfBlob);

        resultDiv.innerHTML = `
          <iframe src="${lastPdfUrl}"></iframe>
          <p><a href="${lastPdfUrl}" download="result.pdf">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å PDF</a></p>
        `;

      } catch (err) {
        errorBlock.style.display = "block";
        errorBlock.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${err}`;
        resultDiv.innerHTML = "";
      }
    });
  </script>
</body>
</html>